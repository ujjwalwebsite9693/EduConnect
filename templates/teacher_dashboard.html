{% extends "base.html" %}

{% block body_class %}bg-dashboard{% endblock %}
{% block main_container_class %}teacher-main{% endblock %}

{# ---------- NAVBAR FOR TEACHER (CUSTOM TABS) ---------- #}
{% block nav_links %}
<li class="nav-item">
  <a class="nav-link active"
     href="#"
     data-role="teacher-tab-link"
     data-target="overview">
    <i class="bi bi-grid-1x2-fill me-1"></i> Overview
  </a>
</li>
<li class="nav-item">
  <a class="nav-link"
     href="#"
     data-role="teacher-tab-link"
     data-target="upload">
    <i class="bi bi-cloud-upload me-1"></i> Upload Paper
  </a>
</li>
<li class="nav-item">
  <a class="nav-link"
     href="#"
     data-role="teacher-tab-link"
     data-target="grading">
    <i class="bi bi-clipboard-check me-1"></i> Grading
  </a>
</li>
<li class="nav-item">
  <a class="nav-link"
     href="#"
     data-role="teacher-tab-link"
     data-target="uploaded-papers">
    <i class="bi bi-files me-1"></i> Uploaded Papers
  </a>
</li>
<li class="nav-item">
  <a class="nav-link"
     href="#"
     data-role="teacher-tab-link"
     data-target="student-solutions">
    <i class="bi bi-folder2-open me-1"></i> Solutions
  </a>
</li>
{% endblock %}

{% block content %}
<div class="teacher-page-wrapper">

  <div class="tab-content" id="teacherTabsContent">

    {# =====================================================
       TAB 1 – OVERVIEW
    ===================================================== #}
    <div class="tab-pane fade teacher-tab-pane show active"
         id="overview">

      <h4 class="section-title mb-3">Dashboard Overview</h4>

      <!-- TOP SUMMARY CARDS -->
      <div class="row g-3 mb-4">

        <!-- Total Uploaded Papers -->
        <div class="col-xl-3 col-md-4 col-6">
          <div class="summary-card hover-card"
               style="background: linear-gradient(135deg,#2563eb,#1d4ed8);">
            <div class="summary-label" style="color: black;"><b>Total Uploaded Papers</b></div>
            <div class="summary-value" style="color: white;"><b>{{ total_papers }}</b></div>
            <div class="summary-subtext" style="color: yellow;"><b>All Sample Papers Uploaded</b></div>
          </div>
        </div>

        <!-- Answered Papers -->
        <div class="col-xl-3 col-md-4 col-6">
          <div class="summary-card hover-card"
               style="background: linear-gradient(135deg,#10b981,#059669);">
            <div class="summary-label" style="color: black;"><b>Answered Papers</b></div>
            <div class="summary-value" style="color: white;"><b>{{ total_answered_papers }}</b></div>
            <div class="summary-subtext" style="color: rgb(0, 0, 0);"><b>At Least One Submission</b></div>
          </div>
        </div>

        <!-- Not Answered Papers -->
        <div class="col-xl-3 col-md-4 col-6">
          <div class="summary-card hover-card"
               style="background: linear-gradient(135deg,#fb923c,#f97316);">
            <div class="summary-label" style="color: black;"><b>Not Answered</b></div>
            <div class="summary-value" style="color: white;">{{ total_not_answered_papers }}</div>
            <div class="summary-subtext" style="color: white;"><b>No Student Attempts Yet</b></div>
          </div>
        </div>

        <!-- Graded Submissions -->
        <div class="col-xl-3 col-md-4 col-6">
          <div class="summary-card hover-card"
               style="background: linear-gradient(135deg,#22c55e,#16a34a);">
            <div class="summary-label" style="color: black;"><b>Graded Submissions</b></div>
            <div class="summary-value" style="color: white;">{{ total_graded_solutions }}</div>
            <div class="summary-subtext" style="color: rgb(102, 0, 107);"><b>Results Published</b></div>
          </div>
        </div>

        <!-- Pending Grading -->
        <div class="col-xl-3 col-md-4 col-6">
          <div class="summary-card hover-card"
               style="background: linear-gradient(135deg,#eab308,#ca8a04);">
            <div class="summary-label" style="color: black;"><b>Pending Grading</b></div>
            <div class="summary-value" style="color: white;">{{ total_not_graded_solutions }}</div>
            <div class="summary-subtext" style="color: rgb(25, 0, 186);"><b>Waiting For Marks</b></div>
          </div>
        </div>

        <!-- Average Marks -->
        <div class="col-xl-3 col-md-4 col-6">
          <div class="summary-card hover-card"
               style="background: linear-gradient(135deg,#6366f1,#4f46e5);">
            <div class="summary-label" style="color: black;"><b>Average Marks</b></div>
            <div class="summary-value" style="color: white;">{{ avg_marks }}%</div>
            <div class="summary-subtext" style="color: rgb(38, 255, 0);"><b>Across All Graded Submissions</b></div>
          </div>
        </div>

        <!-- Best Performer -->
        <div class="col-xl-3 col-md-4 col-6">
          <div class="summary-card hover-card"
               style="background: linear-gradient(135deg,#ec4899,#db2777);">
            <div class="summary-label" style="color: black;"><b>Best Performer</b></div>
            {% if best_student %}
              <div class="summary-value" style="font-size:1.25rem; color: white;">
                {{ best_student.name }}
              </div>
              <div class="summary-subtext" style="color: rgb(238, 255, 0);">
               <b>{{ best_student.avg }}% Average </b>
              </div>
            {% else %}
              <div class="summary-value">N/A</div>
              <div class="summary-subtext">No graded papers yet</div>
            {% endif %}
          </div>
        </div>

        <!-- Total Students -->
        <div class="col-xl-3 col-md-4 col-6">
          <div class="summary-card hover-card"
               style="background: linear-gradient(135deg,#0ea5e9,#0284c7);">
            <div class="summary-label" style="color: black;"><b>Total Students</b></div>
            <div class="summary-value" style="color: white;">{{ total_students }}</div>
            <div class="summary-subtext" style="color: rgb(15, 0, 61);"><b>Active In This System</b></div>
          </div>
        </div>

      </div>

      <!-- STUDENT PERFORMANCE CARDS -->
      <h5 class="section-title mb-3">Student Performance</h5>
      <div class="row g-3">
        {% for st in student_stats %}
        <div class="col-xl-4 col-md-6">
          <div class="student-card hover-card">
            <div class="student-card-header">
              <div class="student-avatar">
                {{ st.name[0] if st.name else st.username[0] }}
              </div>
              <div>
                <div class="student-name">{{ st.name }}</div>
                <div class="student-username">@{{ st.username }}</div>
              </div>
            </div>

            <div class="student-metrics">
              <div class="metric-box">
                <div class="metric-label">Solved</div>
                <div class="metric-value">{{ st.count }}</div>
                <div class="metric-sub">Papers</div>
              </div>
              <div class="metric-box metric-accent">
                <div class="metric-label">Average</div>
                <div class="metric-value text-accent">
                  {{ st.avg if st.avg is not none else 0 }}%
                </div>
                <div class="metric-sub">Score</div>
              </div>
            </div>

            <div class="student-progress">
              <div class="d-flex justify-content-between small mb-1">
                <span>Progress</span>
                <span>{{ st.count }}/{{ total_papers }}</span>
              </div>
              <div class="progress progress-thin">
                {% set frac = (st.count / total_papers * 100) if total_papers > 0 else 0 %}
                <div class="progress-bar" style="width: {{ frac }}%;"></div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

    </div> <!-- /overview tab -->


    {# =====================================================
       TAB 2 – UPLOAD PAPER
    ===================================================== #}
    <div class="tab-pane fade teacher-tab-pane"
         id="upload">
      <div class="center-card hover-card">
        <h5 class="mb-3 fw-semibold text-light">Upload New Sample Paper</h5>

        <form method="POST" action="{{ url_for('upload_paper') }}" enctype="multipart/form-data">
          <div class="mb-3">
            <label class="form-label small text-muted">Paper Title</label>
            <input type="text" name="title" class="form-control upload-input"
                   placeholder="e.g., Maths Mid Term 2024" required>
          </div>

          <div class="mb-3">
            <label class="form-label small text-muted">Description (optional)</label>
            <textarea class="form-control upload-input" name="description" rows="3"
                      placeholder="Short instructions for students..."></textarea>
          </div>

          <div class="mb-4">
            <label class="form-label small text-muted">Upload PDF</label>
            <div class="upload-dropzone">
              <i class="bi bi-file-earmark-pdf upload-icon"></i>
              <p class="mb-1">Click to upload PDF</p>
              <small class="text-muted">Only .pdf files allowed</small>
              <input type="file" name="file" accept=".pdf" required>
            </div>
          </div>

          <button class="btn upload-btn w-100 rounded-pill">
            Publish Paper
          </button>
        </form>
      </div>
    </div> <!-- /upload tab -->


    {# =====================================================
       TAB 3 – GRADING
    ===================================================== #}
    <div class="tab-pane fade teacher-tab-pane"
         id="grading">
      <div class="center-card hover-card">
        <h5 class="mb-3 fw-semibold text-light">Grade Submissions</h5>

        {% if solutions %}
        <div class="table-responsive small">
          <table class="table align-middle grading-table">
            <thead>
              <tr>
                <th>Student</th>
                <th>Paper</th>
                <th>View</th>
                <th>Total</th>
                <th>Obtained</th>
                <th>Passing</th>
                <th>Total Q.</th>
                <th>Attempted</th>
                <th>Correct</th>
                <th>Incorrect</th>
                <th>Save</th>
              </tr>
            </thead>
            <tbody>
              {% for s in solutions %}
                {% set paper = (papers | selectattr('id','equalto',s.paper_id) | list | first) %}
                <tr>
                  <td>@{{ s.student_username }}</td>
                  <td>{{ paper.title if paper else 'Unknown' }}</td>
                  <td>
                    <a href="{{ url_for('view_submission', group_id=s.group_id) }}"
                       class="btn btn-outline-accent btn-sm">
                      View
                    </a>
                  </td>
                  <form method="POST" action="{{ url_for('grade_solution') }}">
                    <input type="hidden" name="group_id" value="{{ s.group_id }}">
                    <td style="width:110px;">
                      <input type="number" step="0.5" name="total_marks"
                             class="form-control form-control-sm upload-input"
                             placeholder="Total" required>
                    </td>
                    <td style="width:110px;">
                      <input type="number" step="0.5" name="obtained_marks"
                             class="form-control form-control-sm upload-input"
                             placeholder="Obt." required>
                    </td>
                    <td style="width:110px;">
                      <input type="number" step="0.5" name="passing_marks"
                             class="form-control form-control-sm upload-input"
                             placeholder="Pass" required>
                    </td>
                    <td style="width:110px;">
                      <input type="number" name="total_questions"
                             class="form-control form-control-sm upload-input"
                             placeholder="Total Q." required>
                    </td>
                    <td style="width:110px;">
                      <input type="number" name="attempted"
                             class="form-control form-control-sm upload-input"
                             placeholder="Attempted" required>
                    </td>
                    <td style="width:110px;">
                      <input type="number" name="correct"
                             class="form-control form-control-sm upload-input"
                             placeholder="Correct" required>
                    </td>
                    <td style="width:110px;">
                      <input type="number" name="incorrect"
                             class="form-control form-control-sm upload-input"
                             placeholder="Incorrect" required>
                    </td>
                    <td>
                      <button class="btn btn-success btn-sm rounded-pill">
                        Save
                      </button>
                    </td>
                  </form>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <p class="text-muted small mb-0">No submissions to grade.</p>
        {% endif %}
      </div>
    </div> <!-- /grading tab -->


    {# =====================================================
       TAB 4 – UPLOADED PAPERS
    ===================================================== #}
    <div class="tab-pane fade teacher-tab-pane"
         id="uploaded-papers">
      <div class="center-card hover-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="fw-semibold text-light mb-0">Uploaded Papers</h5>
          <span class="badge rounded-pill bg-soft-primary text-primary">
            Total: {{ total_papers }}
          </span>
        </div>

        {% if papers %}
        <div class="table-responsive small">
          <table class="table align-middle grading-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Uploaded At</th>
                <th>Download</th>
                <th>Rename</th>
                <th>Delete</th>
              </tr>
            </thead>
            <tbody>
              {% for p in papers %}
              <tr>
                <td>#{{ p.id }}</td>
                <td>{{ p.title }}</td>
                <td>{{ p.uploaded_at }}</td>
                <td>
                 <td>
  <a href="{{ url_for('download_paper', paper_id=p.id) }}"
   class="btn btn-sm btn-outline-primary rounded-pill"
   target="_blank">
  Download
</a>


</td>


                </td>
                <td>
                  <form method="POST" action="{{ url_for('rename_paper') }}" class="d-flex gap-2">
                    <input type="hidden" name="paper_id" value="{{ p.id }}">
                    <input type="text" name="new_title"
                           class="form-control form-control-sm upload-input"
                           placeholder="New title" required>
                    <button class="btn btn-success btn-sm rounded-pill">Save</button>
                  </form>
                </td>
                <td>
                  <form method="POST" action="{{ url_for('delete_paper') }}"
                        onsubmit="return confirm('Delete this paper and all its solutions?');">
                    <input type="hidden" name="paper_id" value="{{ p.id }}">
                    <button class="btn btn-outline-danger btn-sm rounded-pill">
                      Delete
                    </button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <p class="text-muted small mb-0">No papers uploaded yet.</p>
        {% endif %}
      </div>
    </div> <!-- /uploaded-papers tab -->


    {# =====================================================
       TAB 5 – STUDENT SOLUTIONS (GROUPED)
    ===================================================== #}
    <div class="tab-pane fade teacher-tab-pane"
         id="student-solutions">
      <div class="center-card hover-card">
        <h5 class="mb-3 fw-semibold text-light">Student Solutions</h5>

        {% if grouped_solutions %}
        <div class="accordion" id="studentSolutionsAccordion">
          {% for grp in grouped_solutions %}
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading-{{ loop.index }}">
              <button class="accordion-button collapsed" type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapse-{{ loop.index }}"
                      aria-expanded="false"
                      aria-controls="collapse-{{ loop.index }}">
                <div class="d-flex align-items-center gap-2">
                  <div class="grading-avatar">
                    {{ grp.username[0] }}
                  </div>
                  <div>
                    <div class="fw-semibold">{{ grp.name }}</div>
                    <div class="small text-muted">
                      @{{ grp.username }} — {{ grp.count }} submissions
                    </div>
                  </div>
                </div>
              </button>
            </h2>
            <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse"
                 aria-labelledby="heading-{{ loop.index }}"
                 data-bs-parent="#studentSolutionsAccordion">
              <div class="accordion-body">
                <div class="table-responsive small">
                  <table class="table align-middle grading-table mb-0">
                    <thead>
                      <tr>
                        <th>Paper</th>
                        <th>Submitted</th>
                        <th>Marks</th>
                        <th>View</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for s in grp.solutions %}
                      <tr>
                        <td>{{ s.paper_title }}</td>
                        <td>{{ s.submitted_at }}</td>
                        <td>{{ s.marks if s.marks is not none else 'Not graded' }}</td>
                        <td>
                          <a href="{{ url_for('view_submission', group_id=s.group_id) }}"
   class="btn btn-sm btn-outline-info rounded-pill">
  <i class="bi bi-eye me-1"></i> View
</a>

                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
          <p class="text-muted small mb-0">No solutions uploaded yet.</p>
        {% endif %}
      </div>
    </div> <!-- /student-solutions tab -->

  </div>
</div>

{# ---------- SIMPLE JS TAB SWITCHER (NO BOOTSTRAP DEPENDENCY) ---------- #}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const links = document.querySelectorAll('[data-role="teacher-tab-link"]');
  const panes = document.querySelectorAll('.teacher-tab-pane');

  links.forEach(link => {
    link.addEventListener('click', function (e) {
      e.preventDefault();

      const targetId = this.getAttribute('data-target');
      if (!targetId) return;

      // deactivate all
      links.forEach(l => l.classList.remove('active'));
      panes.forEach(p => p.classList.remove('show', 'active'));

      // activate clicked
      this.classList.add('active');
      const targetPane = document.getElementById(targetId);
      if (targetPane) {
        targetPane.classList.add('active', 'show');
      }
    });
  });
});
</script>
{% endblock %}
